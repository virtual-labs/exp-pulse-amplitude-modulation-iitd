<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Virtual Labs</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div id = "container">
    <h1>Instructions for Pulse Width Modulation (PWM)</h1>
    <ul>
        <li>Step 1: Click on 'Generate Message' button to generate input message signal</li>
        <li>Step 2: Then click on 'Generate Carrier' button to generate carrier signal</li>
		<li>Step 3: You can change the message and carrier signal frequencies from the input field. The carrier frequency has to be more than the message frequency</li>
        <li>Step 4: Click on 'Generate PWM Signal' button to generate Pulse Width Modulated (PWM) Signal</li>
    </ul>
<br/>

  <!-- sidebar and body -->
  <div class="flex min-h-[80vh]">
    <div class="px-6 pb-6 flex-1">
      <!--  -->
      <div class="flex">
        <div class="flex-1 flex basis-4/5 flex-col">
          <div class="flex max-lg:flex-col mt-5 items-center gap-x-2 gap-y-2">
		              <div class="flex-1">
              <div class="flex items-center gap-1">
                <label
                  for="messageFrequency"
                  class="text-[#2c99ce] text-md font-medium"
                  >Message Frequency in Hz:</label
                >
                <input
                  class="border w-36 border-black px-1 py-1 rounded-sm"
                  type="number"
                  id="messageFrequency"
                  value="2"
                />
              </div>
            </div>
            <div class="flex-1">
              <div class="flex items-center gap-1">
                <label
                  for="carrierFrequency"
                  class="text-[#2c99ce] text-md font-medium"
                  >Square Carrier Frequency in Hz:</label
                >
                <input
                  class="border w-36 border-black px-1 py-1 rounded-sm"
                  type="number"
                  id="carrierFrequency"
                  value="100"
                />
              </div>
            </div>

          </div>
        </div>
      </div>
      <div class="mt-4 border-t-2">
        <div class="flex gap-2">
          <div class="w-[50%] flex flex-col items-center">
            <div class="relative my-4 w-[659px] h-[233px]">
              <!-- buttons -->
              <div class="absolute top-[110px]">
                <button
                  class="bg-blue-500 text-white rounded-md px-2 py-1"
                  class="button"
                  onclick="generateMessage()"
                >
                  Generate Message
                </button>
              </div>
              <div class="absolute top-[234px] left-[145px]">
                <button
                  class="bg-blue-500 text-white rounded-md px-2 py-1"
                  class="button"
                  onclick="generateCarrier()"
                >
                  Generate Carrier
                </button>
              </div>
<div class="absolute top-[162px] right-[15px] flex flex-col gap-2">
  <button
    class="bg-blue-500 text-white rounded-md px-2 py-1"
    onclick="performPWM()"
  >
    Generate PWM Signal
  </button>
  <button
    class="bg-blue-500 text-white rounded-md px-2 py-1"
    onclick="runDemodSimulation()"
  >
    Perform PWM Demodulation
  </button>
</div>

              <img
                src=".././images/PWM_PPM.png"
                alt="PWM"
                class="w-[100%] h-[100%]"
              />
            </div>
          </div>
<div class="flex flex-col justify-center items-center">
  <div class="w-[600px] h-[400px] mb-5">
    <div id="pwmChart" class="w-[600px] h-[400px]"></div>
  </div>

  <div class="w-[600px] h-[400px] mb-5">
    <div id="carrierChart" class="w-[600px] h-[400px]"></div>
  </div>

  <div class="w-[600px] h-[400px] mb-5">
    <div id="messageChart" class="w-[600px] h-[400px]"></div>
  </div>
</div>

        </div>
      </div>
    </div>
  </div>
  
  <br/><br/><hr/>
  
  <div id = "container">
    <h1>Instructions for Pulse Width Demodulation</h1>
    <ul>
	    <li>Step 1: Ramp generator produces a ramp signal that either increases or decreases linearly. And Converts pulse width information into a varying voltage. Adder combines the ramp and PWM signals into a composite signal carrying the original information and then low-pass filtering</li>
		<li>Step 2: You can Demodulate the PWM Signal clicking on the 'Demodulate PWM Signal' button</li>
    </ul>
</div>	
  
  <!-- sidebar and body -->
  <div class="flex min-h-[80vh]">
    <div class="px-6 pb-6 flex-1">
      <div class="flex">
        <div class="flex-1 flex basis-4/5 flex-col">
          <div class="flex max-lg:flex-col mt-5 items-center gap-x-2 gap-y-2">
            <!-- Input fields -->

          </div>
        </div>
        <div class="flex-1 flex items-center gap-2 py-2 flex-col basis-1/5">

        </div>
      </div>
      <div class="mt-4 border-t-2">
        <div class="flex gap-2">
          <div class="w-[50%] flex flex-col items-center">
            <div class="relative my-4 w-[659px] h-[233px]">
              <!-- buttons -->
              <div class="absolute top-[170px] right-[-15px]">
                <button class="bg-blue-500 text-white rounded-md px-2 py-1" onclick="runDemodSimulation()" id = "modtodemod">Demodulate PWM Signal</button>
				
              </div>
              <img src=".././images/PWM_demod.png" alt="PWM_Demodulation" class="w-[100%] h-[100%]" />
            </div>
          </div>
		  
		    <div class="flex justify-center flex-wrap items-center">
              <div class="m-1">
                <!-- <h2 class="text-center font-medium text-[#2c99ce]">Demodulated Signal</h2> -->
                <div id="plot4" style="width: 600px; height: 400px;"></div>
              </div>
            </div>
        </div>
      </div>
    </div>
  </div>

	
    <script>
        function checkFrequencies() {
            // Get values from input fields
            let carrierFrequency = parseFloat(document.getElementById('carrierFrequency').value);
            let messageFrequency = parseFloat(document.getElementById('messageFrequency').value);
            
            // Check the frequencies
            if (carrierFrequency <= messageFrequency) {
                alert("Carrier frequency should be greater than message frequency.");
		    window.location.reload(true); 
            } else {
                console.log("Carrier frequency is greater than message frequency.");
            }
        }

        // Function to attach event listeners to all buttons
        function attachEventListeners() {
            let buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', checkFrequencies);
            });
        }

        // Attach event listeners when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', attachEventListeners);

    </script>
	
 
 
    <script>
      function linspace(start, end, num) {
        const step = (end - start) / (num - 1);
        return Array.from({ length: num }, (_, index) => start + index * step);
      }

      function destroyChart(canvasId) {
        const canvas = document.getElementById(canvasId);
        if (canvas) {
          const context = canvas.getContext("2d");
          context.clearRect(0, 0, canvas.width, canvas.height);
          const existingChart = Chart.getChart(canvas);
          if (existingChart) {
            existingChart.destroy();
          }
        }
      }

      function generateSawtoothSignal(frequency, duration, sampleRate) {
        const numSamples = duration * sampleRate;
        const signal = new Float32Array(numSamples);

        for (let i = 0; i < numSamples; i++) {
          const t = i / sampleRate;
          signal[i] = (t % (1 / frequency)) * frequency * 2 - 1; // Sawtooth waveform formula
        }

        return signal;
      }

      async function generateMessage() {
        //destroyChart("messageChart");

        const duration = 1;
        const resolution = 100*parseFloat(
      document.getElementById("carrierFrequency").value
    );
        const t = linspace(0, duration, resolution * duration);

        const messageFrequency = parseFloat(
          document.getElementById("messageFrequency").value
        );

        if (isNaN(messageFrequency)) {
          console.error("Invalid message frequency");
          return;
        }

        const a = 1;
        const messageSignal = linspace(0, duration, resolution * duration).map(
          (t) => 1.01 * a * Math.sin(2 * Math.PI * messageFrequency * t + 0.5)
        );

        //plotSignal("messageChart", t, messageSignal, "Message Signal");
			    // Plotting with Plotly
    const carrierPlotData = [{
        x: t,
        y: messageSignal,
        type: 'scatter',
        mode: 'lines',
        name: 'Message Signal',
        //line: { color: 'blue', width: 2 }
    }];

    const layout = {
        title: 'Message Signal',
        xaxis: {
            title: 'Time (s)',
        },
        yaxis: {
            title: 'Amplitude',
            //range: [-1, 1],
        }
    };

    // Create or update the plot in the specified chart element
    Plotly.newPlot('messageChart', carrierPlotData, layout);
		
		    // Scroll to the message chart after it has been generated
    document.getElementById("messageChart").scrollIntoView({
      behavior: "smooth",
      block: "center"
    });
	
     //   return messageSignal;
      }

      async function generateCarrier() {
        //destroyChart("carrierChart");

        const duration = 1;
        const resolution = 100*parseFloat(
      document.getElementById("carrierFrequency").value
    );
        const t = linspace(0, duration, resolution * duration);

        const carrierFrequency = parseFloat(
          document.getElementById("carrierFrequency").value
        );

        if (isNaN(carrierFrequency)) {
          console.error("Invalid carrier frequency");
          return;
        }

        const fc = carrierFrequency;
        const a = 1;
        const carrierSignal = linspace(0, duration, resolution * duration).map(
          (t) => a * Math.sign(Math.sin(2 * Math.PI * fc * t + 0.5))
        );

        //plotSignal("carrierChart", t, carrierSignal, "Square Carrier Signal");
					    // Plotting with Plotly
    const carrierPlotData = [{
        x: t,
        y: carrierSignal,
        type: 'scatter',
        mode: 'lines',
        name: 'Square Carrier Signal',
        //line: { color: 'blue', width: 2 }
    }];

    const layout = {
        title: 'Square Carrier Signal',
        xaxis: {
            title: 'Time (s)',
        },
        yaxis: {
            title: 'Amplitude',
            //range: [-1, 1],
        }
    };

    // Create or update the plot in the specified chart element
    Plotly.newPlot('carrierChart', carrierPlotData, layout);
		    // Scroll to the carrier chart after it has been generated
    document.getElementById("carrierChart").scrollIntoView({
      behavior: "smooth",
      block: "center"
    });
	
        //return carrierSignal;
      }

      async function generateSignals() {
        const messageSignal = await generateMessage();
        const carrierSignal = await generateCarrier();
        return { messageSignal, carrierSignal };
      }

      async function performPWM() {
        //destroyChart("pwmChart");
        //destroyChart("modulatedChart");

        const duration = 1;
        const resolution = 100*parseFloat(
      document.getElementById("carrierFrequency").value
    );
        const t = linspace(0, duration, resolution * duration);

        //const { messageSignal, carrierSignal } = await generateSignals();

        //if (!messageSignal || !carrierSignal) {
         // console.error("Failed to generate signals");
          //return;
        //}
		        const messageFrequency = parseFloat(
          document.getElementById("messageFrequency").value
        );
		        const carrierFrequency = parseFloat(
          document.getElementById("carrierFrequency").value
        );
        const messageSignal = linspace(0, duration, resolution * duration).map(
          (t) => 1.01 * 1 * Math.sin(2 * Math.PI * messageFrequency * t + 0.5)
        );
		const carrierSignal = linspace(0, duration, resolution * duration).map(
          (t) => 1 * Math.sign(Math.sin(2 * Math.PI * carrierFrequency * t + 0.5))
        );
        const pwmSignal = messageSignal.map((msg, index) =>
          msg >= carrierSignal[index] ? 1 : 0
        );

        //plotSignal("pwmChart", t, pwmSignal, "PWM Signal");
							    // Plotting with Plotly
    const carrierPlotData = [{
        x: t,
        y: pwmSignal,
        type: 'scatter',
        mode: 'lines',
        name: 'PWM Signal',
        //line: { color: 'blue', width: 2 }
    }];

    const layout = {
        title: 'PWM Signal',
        xaxis: {
            title: 'Time (s)',
        },
        yaxis: {
            title: 'Amplitude',
            //range: [-1, 1],
        }
    };

    // Create or update the plot in the specified chart element
    Plotly.newPlot('pwmChart', carrierPlotData, layout);
		
				    // Scroll to the pwm chart after it has been generated
    document.getElementById("pwmChart").scrollIntoView({
      behavior: "smooth",
      block: "center"
    });
	
      }

      function plotSignal(canvasId, time, signal, label) {
        const ctx = document.getElementById(canvasId).getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels: time,
            datasets: [
              {
                label: label,
                data: signal,
                borderColor: "rgba(75, 192, 192, 1)",
                borderWidth: 1,
                fill: false,
              },
            ],
          },
          options: {
            scales: {
              x: {
                type: "linear",
                position: "bottom",
              },
              y: {
                min: -1,
                max: 2,
              },
            },
          },
        });
      }
    </script>



    <script>
        function runDemodSimulation() {
            const fs = parseFloat(document.getElementById('carrierFrequency').value); // Frequency of the square signal
            const fm = parseFloat(document.getElementById('messageFrequency').value);   // Frequency of the message signal
            const a = 1;   // Amplitude

            // Time vector
			const resolution = 100*parseFloat(
      document.getElementById("carrierFrequency").value
    );
            const t = Array.from({ length: (resolution + 1) }, (_, i) => i * (1/resolution));
            
            // Generating a square wave
            const squareWave = t.map(ti => a * 2* (Math.sign(Math.sin(2 * Math.PI * fs * ti)) + 1) / 2 - 1);
            
            // Generating message wave
            const msg = t.map(ti => a * Math.sin(2 * Math.PI * fm * ti));
            
            // PWM generation
            const pwm = msg.map((val, i) => val >= squareWave[i] ? 1 : 0);

 

            // Demodulation
            const demodulatedSignal = new Array(msg.length).fill(0);
            let i = 0;
            while (i < pwm.length - 1) {
                if (pwm[i] === 1) {
                    // Positive pulse width measurement
                    let j = i + 1;
                    while (pwm[j] === 1 && j < pwm.length) {
                        j++;
                    }
                    const mean = msg.slice(i, j).reduce((a, b) => a + b) / (j - i);
                    for (let k = i; k < j; k++) {
                        demodulatedSignal[k] = mean;
                    }
                    i = j; // Move to the next segment
                } else {
                    // Negative pulse width measurement
                    let j = i + 1;
                    while (pwm[j] === 0 && j < pwm.length) {
                        j++;
                    }
                    const mean = msg.slice(i, j).reduce((a, b) => a + b) / (j - i);
                    for (let k = i; k < j; k++) {
                        demodulatedSignal[k] = mean;
                    }
                    i = j; // Move to the next segment
                }
            }

            // Apply low-pass filter (simple moving average for demo purposes)
            const filterSize = Math.floor(fs / fm);
            const filter = Array(filterSize).fill(1 / filterSize);
            const filteredSignal = convolve(demodulatedSignal, filter);

            // Apply smoothing filter (simple moving average for smoothing)
            const smoothingFilterSize = Math.floor(fs / (2 * fm)); // Adjust filter size as needed
            const smoothingFilter = Array(smoothingFilterSize).fill(1 / smoothingFilterSize);
            const smoothedSignal = convolve(filteredSignal, smoothingFilter);

            // Plotting Demodulated Signal
            Plotly.newPlot('plot4', [{
                x: t,
                y: smoothedSignal,
                type: 'scatter'
            }], {
                title: 'Demodulated Signal'
            });
        }

        function convolve(signal, filter) {
            const output = new Array(signal.length + filter.length - 1).fill(0);
            for (let i = 0; i < signal.length; i++) {
                for (let j = 0; j < filter.length; j++) {
                    if (i + j < output.length) {
                        output[i + j] += signal[i] * filter[j];
                    }
                }
            }
			
									            // Scroll to the plot area
            document.getElementById('modtodemod').scrollIntoView({ behavior: 'smooth' });
			
            return output.slice(0, signal.length);
        }
    </script>
	
	
  <style>
  .container {
    background-color: #fff;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    padding: 20px 40px;
    max-width: 1000px; /* Increased max-width to fit three plots side by side */
    margin: 0 auto; /* Center the container */
    text-align: center;
}

h1 {
    color: #333;
    font-size: 22px; /* Increased font size */
    margin-bottom: 20px;
}

ul {
    list-style-type: none;
    padding: 0;
}

li {
    background-color: #e0e7ff;
    margin: 5px 0;
    padding: 5px;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    font-size: 14px; /* Set font size for list items */
}

li::before {
    content: "✔";
    color: #4caf50;
    margin-right: 10px;
}

  </style>
  
</body>
</html>
